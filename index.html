<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Pepinoo üíò</title>

  <style>
    :root{
      --bg1:#ffe3ea; --bg2:#ffb3c1;
      --card:#ffffff;
      --text:#1f1f1f;
      --yes:#ff2e63; --no:#343a40;
    }
    *{box-sizing:border-box}

    body{
      margin:0;
      min-height:100vh;
      display:grid;
      place-items:center;
      font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(circle at top, var(--bg1), var(--bg2));
      color:var(--text);
    }

    .card{
      width:min(92vw, 680px);
      background:var(--card);
      border-radius:26px;
      padding:26px 22px 18px;
      box-shadow:0 18px 60px rgba(0,0,0,.18);
      text-align:center;
      overflow:hidden;
      position:relative;
    }

    .textzone{ position:relative; z-index:10; }

    h1{margin:0 0 10px;font-size:clamp(28px,4vw,42px)}
    p{margin:0 0 12px;font-size:clamp(15px,2.2vw,18px)}

    .speech{
      background:#fff;
      border:2px solid #111;
      border-radius:18px;
      padding:12px 14px;
      font-weight:650;
      margin-top:14px;
      text-align:left;
    }

    /* When YES is clicked we center the gifts vertically */
    .card.giftsMode{
      min-height: min(86vh, 760px);
      display:flex;
      flex-direction:column;
      justify-content:center;
      gap:14px;
      padding:28px 22px 26px;
    }

    .playground{
      margin-top:18px;
      width:100%;
      min-height:260px;
      border-radius:18px;
      background:#fff0f4;
      position:relative;
      overflow:hidden;
      isolation:isolate;
    }

    .gifStage{
      position:absolute;
      inset:0;              /* EXACT same bounds as playground */
      pointer-events:none;
      z-index:0;
      border-radius:18px;
      overflow:hidden;
      opacity:.85;
    }

    .gifWrap{
      position:absolute;
      left:0;
      top:0;
      will-change: transform;
      opacity:0;
      transition: opacity 420ms ease;
    }
    .gifWrap.show{ opacity:.65; }

    .gifSprite{
      display:block;
      transform-origin:0 0;
      user-select:none;
      -webkit-user-drag:none;
    }

    button{
      position:absolute;
      border:0;
      border-radius:999px;
      padding:12px 18px;
      font-weight:800;
      font-size:16px;
      cursor:pointer;
      box-shadow:0 10px 22px rgba(0,0,0,.12);
      white-space:nowrap;
      transition: transform .15s ease, left .15s ease, top .15s ease, opacity .15s ease;
      z-index:5;
    }

    #yes{
      background:var(--yes);
      color:#fff;
      left:50%;
      top:22px;
      transform:translateX(-50%) scale(1);
    }

    #no{
      background:var(--no);
      color:#fff;
      left:50%;
      top:125px;
      transform:translateX(-50%);
      z-index:6;
    }

    footer{
      margin-top:12px;
      font-size:12px;
      opacity:.7;
      position:relative;
      z-index:10;
    }

    .pop{
      position:absolute;
      left:50%;
      top:50%;
      font-size:18px;
      animation:pop 900ms ease-out forwards;
      pointer-events:none;
      z-index:7;
    }
    @keyframes pop{
      to{
        opacity:0;
        transform:translate(calc(-50% + var(--x)), calc(-50% + var(--y))) scale(1.4);
      }
    }

    /* ---------- Gift choices ---------- */
    .giftChoices{
      display:none;
      padding:14px;
      background:#fff0f4;
      border-radius:18px;
      position:relative;
      z-index:10;
      text-align:left;
    }
    .giftChoices.show{ display:block; }

    .giftChoices h2{
      margin:0 0 10px;
      font-size:18px;
      font-weight:900;
      text-align:center;
    }

    .giftGrid{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }

    .giftBtn{
      width:100%;
      border-radius:16px;
      padding:14px 14px;
      border:2px solid rgba(0,0,0,.12);
      background:#fff;
      cursor:pointer;
      font-weight:900;
      display:flex;
      align-items:center;
      justify-content:space-between;
      box-shadow:0 10px 22px rgba(0,0,0,.10);
      transition: transform .15s ease;
      user-select:none;
    }
    .giftBtn:hover{ transform:scale(1.01); }

    /* ---------- Modal system (FIX: modal adapts; body scrolls) ---------- */
    .overlay{
      position:fixed;
      inset:0;
      display:none;
      place-items:center;
      background:rgba(0,0,0,.55);
      padding:18px;
      z-index:9999;
    }
    .overlay.show{ display:grid; }

    .modal{
      width:min(92vw, 720px);
      max-height:min(86vh, 760px);
      background:#fff;
      border-radius:22px;
      box-shadow:0 22px 80px rgba(0,0,0,.35);
      padding:18px;
      position:relative;

      /* NEW */
      display:flex;
      flex-direction:column;
      overflow:hidden; /* modal itself doesn't scroll */
    }

    .modalHeader{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      margin-bottom:10px;

      /* NEW */
      flex: 0 0 auto;
    }
    .modalTitle{
      font-size:18px;
      font-weight:1000;
      margin:0;
    }
    .closeBtn{
      border:0;
      background:#111;
      color:#fff;
      padding:10px 12px;
      border-radius:999px;
      cursor:pointer;
      font-weight:1000;
      position:sticky;
      top:8px;
    }

    .modalBody{
      text-align:left;
      font-size:16px;
      line-height:1.4;

      /* NEW */
      flex: 1 1 auto;
      overflow:auto;           /* only body scrolls */
      padding-bottom:14px;     /* room at bottom */
      -webkit-overflow-scrolling: touch;
    }

    .mediaBox{
      margin-top:12px;
      border-radius:18px;
      overflow:hidden;
      background:#fff0f4;
      border:1px solid rgba(0,0,0,.10);
    }
    .mediaBox img{
      width:100%;
      display:block;
      height:auto;
    }
    .mediaBox video{
      width:100%;
      display:block;
    }

    /* ---------- Gift 3: Envelope + letter (realistic) ---------- */
    .envStage{
      margin-top:14px;
      display:grid;
      place-items:center;

      /* NEW: prevent it from forcing overflow */
      padding-bottom:6px;
    }

    .envelope{
      width:min(560px, 94%);
      /* NEW: responsive height so button doesn't get cut off */
      height:clamp(300px, 55vh, 380px);
      position:relative;
      cursor:pointer;
      user-select:none;
    }

    .envBack{
      position:absolute;
      inset:0;
      background:#fff;
      border-radius:18px;
      border:2px solid rgba(0,0,0,.12);
      box-shadow:0 18px 40px rgba(0,0,0,.18);
      overflow:hidden;
    }

    .envPocket{
      position:absolute;
      left:0; right:0; bottom:0;
      height:58%;
      background:linear-gradient(135deg,#ffd1dc,#ffb3c1);
      border-bottom-left-radius:18px;
      border-bottom-right-radius:18px;
      border-top:2px solid rgba(0,0,0,.08);
    }

    .envPocket::before{
      content:"";
      position:absolute;
      left:0; right:0; top:-2px; bottom:0;
      clip-path:polygon(0 0, 50% 55%, 100% 0, 100% 100%, 0 100%);
      background:rgba(255,255,255,.25);
      pointer-events:none;
    }

    .envFlap{
      position:absolute;
      left:0; right:0; top:0;
      height:62%;
      background:linear-gradient(135deg,#ff7aa5,#ffd1dc);
      clip-path:polygon(0 0, 100% 0, 50% 82%);
      transform-origin:top center;
      transform:rotateX(0deg);
      transition:transform 900ms cubic-bezier(.2,.9,.2,1);
      filter: drop-shadow(0 8px 14px rgba(0,0,0,.12));
    }

    .seal{
      position:absolute;
      left:50%; top:56%;
      transform:translate(-50%,-50%);
      width:44px; height:44px;
      border-radius:999px;
      background:#ff2e63;
      box-shadow:0 10px 20px rgba(0,0,0,.15);
      display:grid;
      place-items:center;
      color:#fff;
      font-weight:1000;
      z-index:3;
    }

    .letter{
      position:absolute;
      left:50%;
      bottom:18px;
      transform:translateX(-50%) translateY(160px);
      width:92%;
      /* NEW: responsive to modal height */
      height:clamp(220px, 42vh, 285px);
      background:#fff;
      border-radius:14px;
      border:1px solid rgba(0,0,0,.10);
      box-shadow:0 12px 26px rgba(0,0,0,.16);
      transition:transform 900ms cubic-bezier(.2,.9,.2,1);
      z-index:1;
      overflow:hidden;
    }

    .letter::before{
      content:"";
      position:absolute;
      inset:0;
      background:
        linear-gradient(transparent 0 26px, rgba(0,0,0,.05) 27px) 0 0 / 100% 28px;
      opacity:.45;
      pointer-events:none;
    }

    .letterPaper{
      position:relative;
      z-index:2;
      margin:14px;
      background:#fff0f4;
      border:1px solid rgba(0,0,0,.10);
      border-radius:12px;
      padding:14px;
      font-weight:750;
      white-space:pre-wrap;
      min-height:210px;
    }

    .envelope.open .envFlap{
      transform:rotateX(165deg);
    }
    .envelope.open .letter{
      transform:translateX(-50%) translateY(-14px);
    }

    .musicRow{
      margin-top:12px;
      display:flex;
      justify-content:center;
    }
    .miniBtn{
      border:0;
      border-radius:999px;
      padding:10px 12px;
      font-weight:1000;
      cursor:pointer;
      box-shadow:0 10px 22px rgba(0,0,0,.12);
      background:#fff;
      color:#111;
      border:2px solid rgba(0,0,0,.15);
    }

    .cursor{
      display:inline-block;
      width:8px;
      margin-left:2px;
      animation: blink 1s steps(2, end) infinite;
      opacity:.9;
      transform: translateY(1px);
    }
    @keyframes blink {
      0%, 49% { opacity: 1; }
      50%, 100% { opacity: 0; }
    }

    /* ---------- OPENING FX (face.png + opening.mp3) ---------- */
    .openFx{
      position:fixed;
      inset:0;
      display:none;
      place-items:center;
      z-index:10050;
      pointer-events:all;
      background:rgba(0,0,0,.10);
    }
    .openFx.show{ display:grid; }

    .openFx img{
      width:min(240px, 55vw);
      height:auto;
      display:block;
      opacity:0;
      transform: scale(0) rotate(0deg);
      filter: drop-shadow(0 18px 35px rgba(0,0,0,.25));
    }

    .openFx.run img{
      animation: openFxAnim 2s ease-in-out forwards;
    }

    @keyframes openFxAnim{
      0%   { opacity:0; transform: scale(0)   rotate(0deg); }
      10%  { opacity:1; }
      50%  { opacity:1; transform: scale(1.25) rotate(360deg); }
      100% { opacity:0; transform: scale(0)   rotate(720deg); }
    }
  </style>
</head>

<body>

<main class="card" id="mainCard">

  <div class="textzone">
    <h1>Para la futura Doctora...te gustaria ser mi San Valentin ü´∂</h1>

    <p id="subtitleText">
      Esta bien si quieres romper mi coranzoncito de pollito üòû
    </p>

    <div class="speech" id="speechBox">
      <span id="speechText">selecciona....</span>
    </div>
  </div>

  <div class="playground" id="playground">
    <div class="gifStage" id="gifStage"></div>
    <button id="yes">Osiiiii</button>
    <button id="no">Nellll</button>
  </div>

  <section id="giftChoices" class="giftChoices">
    <h2>Ahora elige tu regalito üéÅ</h2>
    <div class="giftGrid">
      <div class="giftBtn" id="gift1Btn">üéÄ Regalo #1</div>
      <div class="giftBtn" id="gift2Btn">üé• Regalo #2</div>
      <div class="giftBtn" id="gift3Btn">üíå Regalo #3</div>
    </div>
  </section>

  <footer>~cacacacarlitosss~</footer>
</main>

<!-- Opening FX overlay -->
<div class="openFx" id="openFx" aria-hidden="true">
  <img src="face.png" alt="opening face"/>
</div>

<!-- Sound effect -->
<audio id="openSfx" preload="auto">
  <source src="opening.mp3" type="audio/mpeg">
</audio>

<!-- ---------- MODALS ---------- -->
<div class="overlay" id="overlay">

  <!-- Gift 1 Modal -->
  <div class="modal" id="modalGift1" style="display:none;">
    <div class="modalHeader">
      <h3 class="modalTitle">üéÄ Regalo #1</h3>
      <button class="closeBtn" data-close>Close ‚úñ</button>
    </div>
    <div class="modalBody">
      <p id="gift1Text"></p>
      <div class="mediaBox">
        <img id="gift1Image" src="gift1.jpg" alt="Gift 1 image">
      </div>
    </div>
  </div>

  <!-- Gift 2 Modal -->
  <div class="modal" id="modalGift2" style="display:none;">
    <div class="modalHeader">
      <h3 class="modalTitle">üé• Regalo #2</h3>
      <button class="closeBtn" data-close>Close ‚úñ</button>
    </div>
    <div class="modalBody">
      <p id="gift2Text"></p>
      <div class="mediaBox">
        <video id="gift2Video" controls playsinline preload="metadata">
          <source src="gift2.mp4" type="video/mp4">
          Your browser does not support the video tag.
        </video>
      </div>
    </div>
  </div>

  <!-- Gift 3 Modal (ENVELOPE) -->
  <div class="modal" id="modalGift3" style="display:none;">
    <div class="modalHeader">
      <h3 class="modalTitle">üíå Regalo #3</h3>
      <button class="closeBtn" data-close>Close ‚úñ</button>
    </div>

    <div class="modalBody">
      <div class="envStage">
        <div class="envelope" id="envelope">
          <div class="envBack"></div>
          <div class="envFlap"></div>
          <div class="envPocket"></div>
          <div class="seal">‚ù§</div>
          <div class="letter">
            <div class="letterPaper" id="gift3Letter"></div>
          </div>
        </div>

        <div class="musicRow">
          <button class="miniBtn" id="musicBtn">Play Music üé∂</button>
        </div>

        <audio id="gift3Music" preload="auto" loop>
          <source src="love.mp3" type="audio/mpeg">
        </audio>
      </div>
    </div>
  </div>

</div>

<script>
  // ----- DOM -----
  const mainCard = document.getElementById('mainCard');
  const yesBtn = document.getElementById('yes');
  const noBtn  = document.getElementById('no');
  const speechText = document.getElementById('speechText');
  const speechBox = document.getElementById('speechBox');
  const subtitleText = document.getElementById('subtitleText');
  const playground = document.getElementById('playground');
  const gifStage = document.getElementById('gifStage');

  const giftChoices = document.getElementById('giftChoices');
  const gift1Btn = document.getElementById('gift1Btn');
  const gift2Btn = document.getElementById('gift2Btn');
  const gift3Btn = document.getElementById('gift3Btn');

  const overlay = document.getElementById('overlay');
  const modalGift1 = document.getElementById('modalGift1');
  const modalGift2 = document.getElementById('modalGift2');
  const modalGift3 = document.getElementById('modalGift3');

  const musicBtn = document.getElementById('musicBtn');
  const gift3Music = document.getElementById('gift3Music');
  const gift2Video = document.getElementById('gift2Video');
  const gift3Letter = document.getElementById('gift3Letter');
  const envelope = document.getElementById('envelope');

  // Gift text nodes
  const gift1TextEl = document.getElementById('gift1Text');
  const gift2TextEl = document.getElementById('gift2Text');

  gift1TextEl.textContent =
    "When it comes to you, I remember every little detail in every little conversation we have. And you know that no matter what, I'll always try to make you happy.";

  gift2TextEl.textContent =
    "This is the movie I play in my head when I think about you...";

  // Opening FX
  const openFx = document.getElementById('openFx');
  const openSfx = document.getElementById('openSfx');
  let fxRunning = false;

  // ----- No Lines -----
  const noLines = [
    "Hmmm obviamente fue x curiosidad",
    "guaoooooooooo",
    "no pense que iba hacer asi de dificil",
    "ok ya duele un poquito üòï",
    "pucha pero no seas mala üò£",
    "tanto esfuerzo y enserio no quieres saber lo que te espera üëÄ",
    "porfi ü•∫",
    "oseaaa me odias ü§ï",
    "que tipo de doctora causa tanto dolor üíî",
    "OKAY YA BASTA üò≠"
  ];
  let noClicks = 0;
  let yesCentered = false;

  function heartPop(n=6){
    for(let i=0;i<n;i++){
      const h=document.createElement('div');
      h.className='pop';
      h.textContent=Math.random()>.5?'üíñ':'üíó';
      h.style.setProperty('--x',`${Math.random()*160-80}px`);
      h.style.setProperty('--y',`${Math.random()*120-60}px`);
      playground.appendChild(h);
      setTimeout(()=>h.remove(),900);
    }
  }

  function yesScale(){ return Math.min(3.2,1+noClicks*.16); }

  function positionYes(){
    const s=yesScale();
    if(!yesCentered){
      yesBtn.style.left='50%';
      yesBtn.style.top='22px';
      yesBtn.style.transform=`translateX(-50%) scale(${s})`;
    }else{
      yesBtn.style.left='50%';
      yesBtn.style.top='50%';
      yesBtn.style.transform=`translate(-50%,-50%) scale(${s})`;
    }
  }

  function moveNo(){
    if (noBtn.style.display === 'none') return;

    const pad=12;
    const W = playground.clientWidth;
    const H = playground.clientHeight;

    const nw=noBtn.offsetWidth;
    const nh=noBtn.offsetHeight;

    const maxX = Math.max(pad, W - nw - pad);
    const maxY = Math.max(pad, H - nh - pad);

    const x=pad+Math.random()*(maxX-pad);
    const y=pad+Math.random()*(maxY-pad);

    noBtn.style.left=`${x}px`;
    noBtn.style.top=`${y}px`;
    noBtn.style.transform='none';
  }

  function hideButtons(){
    yesBtn.style.opacity='0';
    noBtn.style.opacity='0';
    yesBtn.disabled=true;
    noBtn.disabled=true;
    setTimeout(()=>{
      yesBtn.style.display='none';
      noBtn.style.display='none';
    },160);
  }
  function hideNoOnly(){
    noBtn.disabled=true;
    noBtn.style.opacity='0';
    setTimeout(()=>{ noBtn.style.display='none'; },160);
  }

  // ----- GIF system -----
  const GIF_SCALE = 0.3;

  const gifPool = [
    "snoopy1.gif","snoopy2.gif","snoopy3.gif","snoopy4.gif","snoopy5.gif",
    "snoopy6.gif","snoopy7.gif","snoopy8.gif","snoopy9.gif"
  ];
  let gifQueue = [...gifPool].sort(() => Math.random() - .5);
  let gifIndex = 0;

  let sprites=[];
  let rafId=null;
  let running=true;

  function rand(min,max){ return Math.random()*(max-min)+min }
  function randNonZero(min,max){
    const v = rand(min,max);
    return Math.random()<.5 ? -v : v;
  }

  function getBounds(){
    return { W: playground.clientWidth, H: playground.clientHeight };
  }

  function spawnGif(){
    if(!running) return;
    if(gifIndex>=gifQueue.length) return;

    const wrap=document.createElement('div');
    wrap.className='gifWrap';

    const img=document.createElement('img');
    img.className='gifSprite';
    img.src=gifQueue[gifIndex++]+'?v='+Date.now();
    img.style.transform=`scale(${GIF_SCALE})`;

    wrap.appendChild(img);
    gifStage.appendChild(wrap);

    img.onload=()=>{
      const { W, H } = getBounds();

      const w=img.naturalWidth*GIF_SCALE;
      const h=img.naturalHeight*GIF_SCALE;

      const s={
        wrap,
        x:(W-w)/2,
        y:(H-h)/2,
        w,h,
        vx:randNonZero(0.45,0.95),
        vy:randNonZero(0.40,0.90)
      };

      s.x = Math.max(0, Math.min(s.x, W - s.w));
      s.y = Math.max(0, Math.min(s.y, H - s.h));

      sprites.push(s);
      wrap.style.transform=`translate(${s.x}px,${s.y}px)`;
      requestAnimationFrame(()=>wrap.classList.add('show'));

      if(!rafId) rafId=requestAnimationFrame(tick);
    };
  }

  function tick(){
    if(!running){
      rafId=null;
      return;
    }

    const { W, H } = getBounds();

    for(const s of sprites){
      if(!s.wrap.isConnected) continue;

      s.x+=s.vx;
      s.y+=s.vy;

      if(s.x<=0){ s.x=0; s.vx*=-1; }
      if(s.y<=0){ s.y=0; s.vy*=-1; }
      if(s.x+s.w>=W){ s.x=Math.max(0,W-s.w); s.vx*=-1; }
      if(s.y+s.h>=H){ s.y=Math.max(0,H-s.h); s.vy*=-1; }

      s.wrap.style.transform=`translate(${s.x}px,${s.y}px)`;
    }

    rafId=requestAnimationFrame(tick);
  }

  function stopAndClearGifs(){
    running=false;
    if(rafId) cancelAnimationFrame(rafId);
    rafId=null;
    sprites.length=0;
    gifStage.innerHTML="";
  }

  // ----- OPENING FX -----
  function playOpeningFxThen(openGiftFn){
    if (fxRunning) return;
    fxRunning = true;

    openFx.classList.add('show');
    openFx.classList.remove('run');
    void openFx.offsetHeight;
    openFx.classList.add('run');

    try{
      openSfx.pause();
      openSfx.currentTime = 0;
      openSfx.play();
    }catch(e){}

    setTimeout(() => {
      openFx.classList.remove('run');
      openFx.classList.remove('show');
      fxRunning = false;
      openGiftFn();
    }, 2000);
  }

  // ----- Modal helpers -----
  function resetGift3(){
    envelope.classList.remove('open');
    cardOpenedOnce = false;
    stopTyping(true);
    gift3Letter.textContent = "";
    if (gift3Music) gift3Music.pause();
    musicBtn.textContent = "Play Music üé∂";
  }

  function openModal(which){
    overlay.classList.add('show');

    modalGift1.style.display = 'none';
    modalGift2.style.display = 'none';
    modalGift3.style.display = 'none';

    if (gift2Video) gift2Video.pause();

    if (which === 1) modalGift1.style.display = 'block';
    if (which === 2) modalGift2.style.display = 'block';
    if (which === 3){
      resetGift3();
      modalGift3.style.display = 'block';
    }
  }

  function closeModal(){
    overlay.classList.remove('show');

    modalGift1.style.display = 'none';
    modalGift2.style.display = 'none';
    modalGift3.style.display = 'none';

    if (gift2Video) gift2Video.pause();
    resetGift3();
  }

  overlay.addEventListener('click', (e)=>{
    if (e.target === overlay) closeModal();
  });

  document.addEventListener('click', (e)=>{
    if (e.target && e.target.matches('[data-close]')) closeModal();
  });

  document.addEventListener('keydown', (e)=>{
    if (e.key === 'Escape') closeModal();
  });

  gift1Btn.addEventListener('click', ()=> playOpeningFxThen(()=>openModal(1)));
  gift2Btn.addEventListener('click', ()=> playOpeningFxThen(()=>openModal(2)));
  gift3Btn.addEventListener('click', ()=> playOpeningFxThen(()=>openModal(3)));

  // ----- Gift 3 typing -----
  let cardOpenedOnce = false;

  const LETTER_TEXT =
`Love can overcome anything
Love can overcome anything
Love can overcome anything
Love can overcome anything
Love can overcome anything
Love can overcome anything`;

  const typingState = {
    timer: null,
    index: 0,
    completed: false,
    speedMs: 18,
    jitterMs: 20,
    cursorEl: null
  };

  function renderLetterText(text){
    gift3Letter.textContent = text;

    if (!typingState.cursorEl){
      const c = document.createElement('span');
      c.className = 'cursor';
      c.textContent = '|';
      typingState.cursorEl = c;
    }
    gift3Letter.appendChild(typingState.cursorEl);
  }

  function stopTyping(clearCursor=false){
    if (typingState.timer){
      clearTimeout(typingState.timer);
      typingState.timer = null;
    }
    if (clearCursor && typingState.cursorEl && typingState.cursorEl.parentNode){
      typingState.cursorEl.parentNode.removeChild(typingState.cursorEl);
    }
    typingState.index = 0;
    typingState.completed = false;
  }

  function startTyping(){
    if (modalGift3.style.display === 'none') return;

    stopTyping(false);
    typingState.index = 0;
    typingState.completed = false;

    renderLetterText("");

    function step(){
      if (modalGift3.style.display === 'none'){
        stopTyping(true);
        return;
      }

      typingState.index++;
      const current = LETTER_TEXT.slice(0, typingState.index);
      renderLetterText(current);

      if (typingState.index >= LETTER_TEXT.length){
        typingState.completed = true;
        typingState.timer = null;
        return;
      }

      const delay = typingState.speedMs + Math.floor(Math.random()*typingState.jitterMs);
      typingState.timer = setTimeout(step, delay);
    }

    typingState.timer = setTimeout(step, 300);
  }

  function openEnvelopeOnce(){
    if (cardOpenedOnce) return;
    cardOpenedOnce = true;
    envelope.classList.add('open');
    setTimeout(startTyping, 650);
  }
  envelope.addEventListener('click', openEnvelopeOnce);

  musicBtn.addEventListener('click', async ()=>{
    try{
      if (gift3Music.paused){
        await gift3Music.play();
        musicBtn.textContent = "Pause Music ‚è∏";
      } else {
        gift3Music.pause();
        musicBtn.textContent = "Play Music üé∂";
      }
    }catch(err){
      musicBtn.textContent = "Tap again üé∂";
    }
  });

  // ----- Main events -----
  yesBtn.addEventListener('click', ()=>{
    stopAndClearGifs();
    hideButtons();

    playground.style.display = 'none';
    speechBox.style.display = 'none';
    subtitleText.style.display = 'none';

    mainCard.classList.add('giftsMode');
    giftChoices.classList.add('show');
  });

  noBtn.addEventListener('click', ()=>{
    if(noClicks>=10) return;

    speechText.textContent = noLines[noClicks];
    noClicks++;

    if(noClicks===1) yesCentered=true;

    heartPop(6);
    positionYes();
    spawnGif();

    requestAnimationFrame(()=>moveNo());

    if(noClicks===10){
      hideNoOnly();
    }
  });

  window.addEventListener('load', positionYes);
  window.addEventListener('resize', ()=>{
    positionYes();
  });
</script>

</body>
</html>
